{% load djicons i18n %}

<div x-data="{
    selectedIds: [],
    selectAll: false,
    deleteConfirm: false,
    deleteTarget: null,
    cancelModal: false,
    cancelTarget: null,
    cancelReason: '',
    toggleSelect(id) {
        const idx = this.selectedIds.indexOf(id);
        if (idx > -1) this.selectedIds.splice(idx, 1);
        else this.selectedIds.push(id);
        this.selectAll = false;
    },
    toggleAll(ids) {
        if (this.selectAll) this.selectedIds = [];
        else this.selectedIds = [...ids];
        this.selectAll = !this.selectAll;
    },
    clearSelection() { this.selectedIds = []; this.selectAll = false; },
    confirmDelete() {
        if (this.deleteTarget) {
            htmx.ajax('POST', this.deleteTarget.url, {
                target: '#datatable-body',
                swap: 'innerHTML',
                headers: { 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || '{{ csrf_token }}' }
            });
        }
        this.deleteConfirm = false;
        this.deleteTarget = null;
    },
    submitCancel() {
        if (this.cancelTarget) {
            const formData = new FormData();
            formData.append('reason', this.cancelReason);
            htmx.ajax('POST', this.cancelTarget.url, {
                target: '#datatable-body',
                swap: 'innerHTML',
                headers: { 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || '{{ csrf_token }}' },
                values: { reason: this.cancelReason }
            });
        }
        this.cancelModal = false;
        this.cancelTarget = null;
        this.cancelReason = '';
    }
}">

    <div class="datatable glass mt-5" id="bookings-datatable">

        <!-- Toolbar -->
        <div class="datatable-toolbar">
            <div class="datatable-toolbar-start">
                <label class="input input-sm datatable-search">
                    {% icon "search-outline" %}
                    <input type="search"
                           name="q"
                           placeholder="{% trans 'Search bookings...' %}"
                           value="{{ search_query|default:'' }}"
                           autocomplete="off"
                           hx-get="{% url 'online_booking:bookings' %}"
                           hx-target="#datatable-body"
                           hx-include="#bookings-datatable"
                           hx-trigger="input changed delay:300ms, search">
                </label>
                <select name="status"
                        class="select select-sm"
                        hx-get="{% url 'online_booking:bookings' %}"
                        hx-target="#datatable-body"
                        hx-include="#bookings-datatable"
                        hx-trigger="change">
                    <option value="">{% trans "All Statuses" %}</option>
                    <option value="pending" {% if status_filter == 'pending' %}selected{% endif %}>{% trans "Pending" %}</option>
                    <option value="confirmed" {% if status_filter == 'confirmed' %}selected{% endif %}>{% trans "Confirmed" %}</option>
                    <option value="cancelled" {% if status_filter == 'cancelled' %}selected{% endif %}>{% trans "Cancelled" %}</option>
                    <option value="completed" {% if status_filter == 'completed' %}selected{% endif %}>{% trans "Completed" %}</option>
                    <option value="no_show" {% if status_filter == 'no_show' %}selected{% endif %}>{% trans "No Show" %}</option>
                </select>
                <input type="date"
                       name="date_from"
                       class="input input-sm"
                       value="{{ date_from|default:'' }}"
                       placeholder="{% trans 'From' %}"
                       hx-get="{% url 'online_booking:bookings' %}"
                       hx-target="#datatable-body"
                       hx-include="#bookings-datatable"
                       hx-trigger="change">
                <input type="date"
                       name="date_to"
                       class="input input-sm"
                       value="{{ date_to|default:'' }}"
                       placeholder="{% trans 'To' %}"
                       hx-get="{% url 'online_booking:bookings' %}"
                       hx-target="#datatable-body"
                       hx-include="#bookings-datatable"
                       hx-trigger="change">
            </div>
            <div class="datatable-toolbar-end">
            </div>
        </div>

        <!-- Bulk Actions Bar -->
        <div class="datatable-bulk" x-show="selectedIds.length > 0" x-cloak>
            <div class="datatable-bulk-info">
                <span class="datatable-bulk-count" x-text="selectedIds.length"></span>
                <span>{% trans "selected" %}</span>
            </div>
            <div class="datatable-bulk-actions">
                <button class="datatable-bulk-btn"
                        hx-post="{% url 'online_booking:bulk_action' %}"
                        hx-target="#datatable-body"
                        hx-include="#bookings-datatable"
                        :hx-vals="JSON.stringify({ids: selectedIds.join(','), action: 'confirm'})"
                        @htmx:after-request="clearSelection()">
                    {% icon "checkmark-circle-outline" %}
                    {% trans "Confirm" %}
                </button>
                <button class="datatable-bulk-btn"
                        hx-post="{% url 'online_booking:bulk_action' %}"
                        hx-target="#datatable-body"
                        hx-include="#bookings-datatable"
                        :hx-vals="JSON.stringify({ids: selectedIds.join(','), action: 'cancel'})"
                        @htmx:after-request="clearSelection()">
                    {% icon "close-circle-outline" %}
                    {% trans "Cancel" %}
                </button>
                <button class="datatable-bulk-btn datatable-bulk-btn-danger"
                        hx-post="{% url 'online_booking:bulk_action' %}"
                        hx-target="#datatable-body"
                        hx-include="#bookings-datatable"
                        :hx-vals="JSON.stringify({ids: selectedIds.join(','), action: 'delete'})"
                        @htmx:after-request="clearSelection()">
                    {% icon "trash-outline" %}
                    {% trans "Delete" %}
                </button>
                <button class="datatable-bulk-clear" @click="clearSelection()" title="{% trans 'Clear selection' %}">
                    {% icon "close-outline" %}
                </button>
            </div>
        </div>

        {% csrf_token %}

        <!-- Hidden state inputs -->
        <input type="hidden" name="sort" value="{{ sort_field|default:'date' }}">
        <input type="hidden" name="dir" value="{{ sort_dir|default:'desc' }}">
        <input type="hidden" name="per_page" value="{{ per_page|default:'10' }}">

        <!-- Datatable Body (HTMX swap target) -->
        <div id="datatable-body">
            {% include "online_booking/partials/bookings_list.html" %}
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal-backdrop" :data-state="deleteConfirm ? 'open' : 'closed'" @click.self="deleteConfirm = false; deleteTarget = null">
        <div class="modal modal-sm">
            <div class="modal-header">
                <h3 class="modal-title">{% trans "Delete Booking" %}</h3>
                <button class="modal-close" @click="deleteConfirm = false; deleteTarget = null">
                    {% icon "close-outline" %}
                </button>
            </div>
            <div class="modal-body">
                <p class="text-sm text-base-content/70">
                    {% trans "Are you sure you want to delete booking" %} <strong x-text="deleteTarget?.ref"></strong>?
                    {% trans "This action cannot be undone." %}
                </p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-ghost btn-sm" @click="deleteConfirm = false; deleteTarget = null">
                    {% trans "Cancel" %}
                </button>
                <button class="btn btn-sm color-error" @click="confirmDelete()">
                    {% icon "trash-outline" %}
                    {% trans "Delete" %}
                </button>
            </div>
        </div>
    </div>

    <!-- Cancel Booking Modal -->
    <div class="modal-backdrop" :data-state="cancelModal ? 'open' : 'closed'" @click.self="cancelModal = false; cancelTarget = null; cancelReason = ''">
        <div class="modal modal-sm">
            <div class="modal-header">
                <h3 class="modal-title">{% trans "Cancel Booking" %}</h3>
                <button class="modal-close" @click="cancelModal = false; cancelTarget = null; cancelReason = ''">
                    {% icon "close-outline" %}
                </button>
            </div>
            <div class="modal-body">
                <p class="text-sm text-base-content/70 mb-4">
                    {% trans "Cancel booking" %} <strong x-text="cancelTarget?.ref"></strong>?
                </p>
                <div class="form-group">
                    <label class="form-group-label">{% trans "Reason (optional)" %}</label>
                    <textarea x-model="cancelReason" class="textarea" rows="2" placeholder="{% trans 'Reason for cancellation...' %}"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-ghost btn-sm" @click="cancelModal = false; cancelTarget = null; cancelReason = ''">
                    {% trans "Keep Booking" %}
                </button>
                <button class="btn btn-sm color-error" @click="submitCancel()">
                    {% icon "close-circle-outline" %}
                    {% trans "Cancel Booking" %}
                </button>
            </div>
        </div>
    </div>

</div>
